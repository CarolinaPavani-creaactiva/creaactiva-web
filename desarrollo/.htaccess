# .htaccess compatible con XAMPP + Go Live + Producción

# -------------------------------------------
# 1) Detectar entorno local (XAMPP / localhost)
# -------------------------------------------
SetEnvIf Remote_Addr "^127\.0\.0\.1$" LOCAL_DEV=1
SetEnvIf Remote_Addr "^::1$" LOCAL_DEV=1
SetEnvIf Host "^localhost" LOCAL_DEV=1

# -------------------------------------------
# 2) Reglas de producción (desactivadas en local)
# -------------------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Ignorar reglas si estamos en XAMPP
  RewriteCond %{ENV:LOCAL_DEV} =1
  RewriteRule ^ - [L]

  # ------------- SOLO PRODUCCIÓN -------------
  # Forzar dominio y HTTPS
  RewriteCond %{HTTP_HOST} !^www\.tudominio\.com$ [NC,OR]
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://www.tudominio\.com%{REQUEST_URI} [L,R=301]

  # Si usas index.php como router:
  # RewriteCond %{REQUEST_FILENAME} !-f
  # RewriteCond %{REQUEST_FILENAME} !-d
  # RewriteRule ^ index.php [L]
</IfModule>

# -------------------------------------------
# 3) Proteger archivos sensibles
# -------------------------------------------
<FilesMatch "^(\.|composer\.(json|lock))">
  <If "%{ENV:LOCAL_DEV} == '1'">
    Require all granted
  </If>
  <Else>
    Require all denied
  </Else>
</FilesMatch>

RedirectMatch 404 /\.git
RedirectMatch 404 /node_modules
RedirectMatch 404 /vendor

<FilesMatch "\.(env|sql|ini|bak|psd|log)$">
  Require all denied
</FilesMatch>

# -------------------------------------------
# 4) Desactivar listado de directorios
# -------------------------------------------
Options -Indexes

# -------------------------------------------
# 5) Headers de seguridad (sin HSTS en local)
# -------------------------------------------
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set X-Frame-Options "SAMEORIGIN"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"

  <If "%{ENV:LOCAL_DEV} != '1'">
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
  </If>
</IfModule>
# -------------------------------------------